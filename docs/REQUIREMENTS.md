# AI电影生成器 - 需求与设计文档

## 1. 项目概述

### 1.1 项目目标
构建一个开源的AI电影生成器，实现从剧本创作到视频成片的完整工作流程，支持多平台API接入，让用户能够灵活选择不同的AI服务提供商。

### 1.2 核心工作流程
```
剧本生成 → 角色设计 → 分镜生成 → 故事板生成 → 视频生成 → 后期合成
```

### 1.3 参考产品
- [Elser AI](https://www.elser.ai/zh/home) - 主要参考其完整工作流程

### 1.4 当前进度

已完成 **Phase 1: 故事生成器 MVP**，包括：
- 基于 Streamlit + Gemini 的故事剧本生成工具
- 完整的故事大纲、角色、分镜生成功能
- 四大视频平台的提示词生成
- 详见 [story_generator.md](../story_generator.md)

---

## 2. 功能需求

### 2.1 剧本模块

#### 2.1.1 剧本生成 ✅ 已实现
- AI辅助生成剧本（目前支持 Gemini）
- 支持长剧本（多集剧情）
- 剧本结构化：角色、剧集、场景、分镜

#### 2.1.2 剧本编辑器 ✅ 已实现
- 剧集大纲编辑（直接/AI辅助）
- 一致性检查与自动修复
- 版本历史管理（撤销/重做）
- 导出功能（Markdown格式）

### 2.2 角色模块

#### 2.2.1 角色设计 ✅ 部分实现
- [x] 角色属性管理（姓名、外貌、性格、背景等）
- [x] 人物数量自定义（1-10个）
- [x] 视觉描述（用于生成提示词）
- [x] 重大经历追踪
- [ ] AI生成角色设定图（待开发）
- [ ] 多角度参考图生成（待开发）

#### 2.2.2 角色一致性方案
| 方案 | 成本 | 效果 | 支持平台 |
|------|------|------|----------|
| 主体参考 | 高 | 好 | 可灵、海螺 |
| 提示词控制 | 低 | 中等 | 所有平台 |
| 混合方案 | 中 | 较好 | 灵活配置 |

### 2.3 分镜模块

#### 2.3.1 分镜生成 ✅ 已实现
- [x] 根据剧集自动生成分镜
- [x] 分镜密度控制（少/中/多/自定义）
- [x] AI生成画面描述
- [x] AI优化画面描述
- [ ] 分镜图片生成（待开发）

#### 2.3.2 分镜管理 ✅ 已实现
- [x] 分镜顺序管理
- [x] 分镜时长设置
- [x] 镜头运动标注
- [x] 对白、音效/配乐标注

### 2.4 视频生成模块

#### 2.4.1 支持的生成模式
1. **图生视频**：提供首帧/首尾帧 + 提示词
2. **文生视频**：仅提供提示词
3. **主体参考**：上传角色参考图保持一致性

#### 2.4.2 视频提示词生成 ✅ 已实现
- [x] 文生视频提示词 (T2V)
- [x] 首帧图片提示词
- [x] 尾帧图片提示词
- [x] 图生视频提示词（首帧/首尾帧）
- [x] 四大平台定制优化

#### 2.4.3 视频参数（待开发）
- [ ] 分辨率选择
- [ ] 时长控制
- [ ] 帧率设置
- [ ] 风格选择

### 2.5 素材管理模块（待开发）
- [ ] 图片素材库
- [ ] 视频片段库
- [ ] 音频素材库
- [ ] 标签与分类
- [ ] 搜索与筛选

### 2.6 项目管理模块 ✅ 已实现
- [x] 项目创建与管理
- [x] 多项目切换
- [x] 项目导出（Markdown）
- [ ] 协作功能（未来扩展）

---

## 3. 技术架构

### 3.1 当前技术栈 (Phase 1)
| 层级 | 技术选型 |
|------|----------|
| 前端/UI | Streamlit |
| AI 模型 | Google Gemini 3 Flash |
| 数据库 | SQLite |
| 语言 | Python 3.13+ |

### 3.2 目标技术栈 (Phase 4)
| 层级 | 技术选型 |
|------|----------|
| 前端 | Next.js 14+ (App Router) |
| 后端 | Python FastAPI |
| 数据库 | SQLite → PostgreSQL |
| 文件存储 | 本地 → S3兼容存储 |
| 任务队列 | Celery + Redis |

### 3.3 系统架构图（目标架构）
```
┌─────────────────────────────────────────────────────────┐
│                    前端 (Next.js)                        │
│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐       │
│  │ 剧本编辑 │ │ 角色管理 │ │ 分镜编辑 │ │ 视频预览 │       │
│  └─────────┘ └─────────┘ └─────────┘ └─────────┘       │
└─────────────────────────────────────────────────────────┘
                           │ API
                           ▼
┌─────────────────────────────────────────────────────────┐
│                   后端 (FastAPI)                         │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐       │
│  │ 项目管理服务 │ │ AI调度服务   │ │ 素材管理服务 │       │
│  └─────────────┘ └─────────────┘ └─────────────┘       │
│  ┌─────────────────────────────────────────────┐       │
│  │              统一AI接口层                     │       │
│  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐        │       │
│  │  │可灵│ │通义│ │即梦│ │海螺│ │更多│        │       │
│  │  └────┘ └────┘ └────┘ └────┘ └────┘        │       │
│  └─────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────┘
                           │
              ┌────────────┼────────────┐
              ▼            ▼            ▼
        ┌─────────┐  ┌─────────┐  ┌─────────┐
        │ SQLite  │  │  Redis  │  │文件存储  │
        └─────────┘  └─────────┘  └─────────┘
```

### 3.4 API设计原则
- RESTful API
- 统一的AI提供商接口抽象
- 支持WebSocket实时进度推送
- 异步任务处理

---

## 4. AI服务提供商接入

### 4.1 LLM（剧本生成）

| 提供商 | 模型 | 用途 | 状态 |
|--------|------|------|------|
| Google Gemini | gemini-3-flash-preview | 剧本生成、分镜描述 | ✅ 已接入 |
| 阿里千问 | Qwen系列 | 剧本生成、分镜描述 | 待接入 |
| 字节豆包 | Doubao系列 | 剧本生成、分镜描述 | 待接入 |
| 智谱AI | GLM系列 | 剧本生成、分镜描述 | 待接入 |
| OpenAI | GPT-4系列 | 剧本生成、分镜描述 | 待接入 |

### 4.2 图片生成

| 提供商 | 功能 | 主体参考 | 状态 |
|--------|------|----------|------|
| 可灵 | 文生图、图生图 | ✅ 支持 | 待接入 |
| 通义万相 | 文生图、图生图 | ⚠️ 有限 | 待接入 |
| 即梦AI | 文生图、图生图 | ⚠️ 有限 | 待接入 |
| 海螺AI | 文生图、图生图 | ✅ 支持 | 待接入 |

### 4.3 视频生成

| 提供商 | 图生视频 | 文生视频 | 首尾帧 | 主体参考 | 最大时长 | 状态 |
|--------|----------|----------|--------|----------|----------|------|
| 可灵 | ✅ | ✅ | ✅ | ✅ | 10秒 | 📄 文档就绪 |
| 通义万相 | ✅ | ✅ | ❌ | ⚠️ | 15秒 | 📄 文档就绪 |
| 即梦AI | ✅ | ✅ | ❌ | ⚠️ | 10秒 | 📄 文档就绪 |
| 海螺视频 | ✅ | ✅ | ✅ | ✅ | 10秒 | 📄 文档就绪 |

---

## 5. 数据模型设计

### 5.1 当前实现的核心实体
```
Project (项目)
├── Characters (角色)
│   └── MajorEvents (重大经历)
├── Episodes (剧集)
│   └── Shots (分镜)
│       └── GeneratedPrompts (生成的提示词)
└── EditHistory (编辑历史)
```

### 5.2 主要表结构

#### projects
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| name | TEXT | 项目名称 |
| description | TEXT | 项目描述/故事简介 |
| genre | TEXT | 故事类型 |
| style | TEXT | 风格描述 |
| target_audience | TEXT | 目标受众 |
| num_episodes | INTEGER | 集数 |
| episode_duration | INTEGER | 每集时长(秒) |
| max_video_duration | INTEGER | 最大视频时长(秒) |
| created_at | DATETIME | 创建时间 |
| updated_at | DATETIME | 更新时间 |

#### characters
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| project_id | INTEGER | 关联项目 |
| name | TEXT | 角色名称 |
| age | TEXT | 年龄 |
| appearance | TEXT | 外貌描述 |
| personality | TEXT | 性格特征 |
| background | TEXT | 背景故事 |
| relationships | TEXT | 人物关系 |
| visual_description | TEXT | 视觉描述(英文) |
| major_events | JSON | 重大经历列表 |

#### episodes
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| project_id | INTEGER | 关联项目 |
| episode_number | INTEGER | 集数 |
| title | TEXT | 标题 |
| outline | TEXT | 大纲 |
| duration | INTEGER | 时长(秒) |
| status | TEXT | 状态 |

#### shots
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| episode_id | INTEGER | 关联剧集 |
| scene_number | INTEGER | 场景编号 |
| shot_number | INTEGER | 镜头编号 |
| shot_type | TEXT | 镜头类型 |
| duration | INTEGER | 时长(秒) |
| visual_description | TEXT | 画面描述 |
| dialogue | TEXT | 对白 |
| sound_music | TEXT | 音效/配乐 |
| camera_movement | TEXT | 镜头运动 |
| notes | TEXT | 备注 |
| generated_prompts | JSON | 生成的提示词 |

#### edit_history
| 字段 | 类型 | 说明 |
|------|------|------|
| id | INTEGER | 主键 |
| project_id | INTEGER | 关联项目 |
| edit_type | TEXT | 编辑类型 |
| target_id | INTEGER | 目标ID |
| field_name | TEXT | 字段名 |
| old_value | TEXT | 旧值(JSON) |
| new_value | TEXT | 新值(JSON) |
| edit_instruction | TEXT | 编辑指令 |
| is_ai_edit | BOOLEAN | 是否AI编辑 |
| is_undone | BOOLEAN | 是否已撤销 |
| created_at | DATETIME | 创建时间 |

---

## 6. 相关文档

- [故事生成器文档](../story_generator.md) - 当前 MVP 的详细说明
- [待办事项](./TODO.md) - 开发计划与进度
- [视频平台文档](./providers/README.md) - 四大平台 API 集成文档

---

*文档版本: 2.0*
*最后更新: 2026-01-24*
