# AI 故事剧本生成器

基于 Google Gemini 大模型驱动的故事和分镜脚本生成工具。

## 功能概述

### 核心功能
- **故事创意生成**: 用户输入创意或一键随机生成
- **故事大纲生成**: AI 自动生成完整故事大纲、角色设定、分集剧情
- **人物知识库**: 管理角色设定，追踪重大经历，保证剧本一致性
- **分镜脚本生成**: 将剧集大纲展开为详细的分镜脚本，支持分镜密度选择
- **视频提示词生成**: 为四大平台生成定制提示词（可灵、通义、即梦、海螺）

### 新增功能
- **人物数量自定义**: 创建项目时可选择 1-10 个主要角色
- **分镜密度控制**: 少/中/多/自定义四档分镜密度选择
- **剧集大纲编辑**: 支持直接编辑和 AI 辅助编辑
- **一致性管理**: AI 自动检测编辑对其他剧集/角色的影响，支持自动修复
- **编辑历史**: 完整的撤销/重做功能，可查看编辑历史
- **一键导出**: 导出故事大纲和人物设定为 Markdown 文件

## 技术栈

- **AI 模型**: Google Gemini 3 Flash (`gemini-3-flash-preview`)
- **SDK**: `google-genai` (新版 Google Gen AI SDK)
- **UI**: Streamlit
- **数据库**: SQLite
- **语言**: Python 3.13+

## 快速开始

### 安装依赖

```bash
pip install -r requirements.txt
```

### 配置 API Key

将 Gemini API Key 保存到项目根目录的 `gemini_api_key` 文件中。

### 启动应用

```bash
./run_story_generator.sh
```

或手动启动:

```bash
streamlit run src/story_generator/app.py --server.port 8502
```

访问 http://localhost:8502

## 项目结构

```
src/story_generator/
├── __init__.py          # 模块导出
├── models.py            # 数据模型 (Project, Character, Episode, Shot, EditHistory等)
├── database.py          # SQLite 数据库操作
├── gemini_client.py     # Gemini API 客户端
└── app.py               # Streamlit UI
```

## 数据模型

### Project (项目)
- 名称、描述、类型、风格、目标受众
- 集数、每集时长、最大视频时长
- 关联角色和剧集

### Character (角色)
- 基本信息: 姓名、年龄、外貌、性格
- 背景故事、人物关系
- 视觉描述 (用于生成一致的图像/视频)
- **重大经历**: 追踪每集发生的重大事件，用于保持剧本一致性

### Episode (剧集)
- 集数、标题、大纲
- 目标时长、状态
- 关联分镜列表

### Shot (分镜)
- 场景编号、镜头编号
- 镜头类型: 大远景、远景、全景、中景、近景、特写等
- 镜头运动: 固定、左摇、右摇、推进、拉远、跟踪等
- 画面描述、对白、音效/配乐
- 生成的提示词 (按平台和类型存储)

### EditHistory (编辑历史)
- 编辑类型、目标ID、字段名
- 旧值、新值、编辑指令
- 是否AI编辑、是否已撤销

## 视频提示词生成

支持为以下平台生成定制提示词:

| 平台 | 特点 |
|------|------|
| **可灵 (Kling)** | 支持中英文，格式: [主体] + [动作] + [场景] + [风格] + [镜头]，支持首尾帧 |
| **通义万相 (Tongyi)** | 支持中文，多镜头叙事，图生视频支持 wan2.6-i2v |
| **即梦 (Jimeng)** | 中英文混合，Pro版多镜头叙事，图生视频支持首帧参考 |
| **海螺 (Hailuo)** | 支持运镜指令: [左摇], [右摇], [推进], [拉远] 等，支持首尾帧生成视频 |

### 提示词类型

| 类型 | 说明 |
|------|------|
| **文生视频 (T2V)** | 纯文本描述生成视频的提示词 |
| **首帧图片** | 图生视频的起始帧图片描述 |
| **尾帧图片** | 图生视频的结束帧图片描述（需配合首帧） |
| **图生视频(首帧)** | 配合首帧图片使用的视频生成提示词 |
| **图生视频(首尾帧)** | 配合首尾帧图片使用的过渡视频提示词 |

### 提示词生成逻辑

- 选择**首帧**时，自动生成：首帧图片提示词 + 图生视频提示词
- 选择**首帧+尾帧**时，自动生成：首帧图片 + 尾帧图片 + 图生视频(首尾帧)提示词
- 尾帧必须配合首帧使用，不能单独选择

## 分镜密度控制

创建分镜时可选择密度：

| 密度 | 说明 |
|------|------|
| 少 | 最少镜头数 = 剧集时长 / 最大视频时长 |
| 中 | 镜头数 = 最少数量 × 1.5 |
| 多 | 镜头数 = 最少数量 × 2 |
| 自定义 | 用户指定具体镜头数量 |

## 剧集编辑与一致性管理

### 编辑方式
1. **直接编辑**: 手动修改剧集标题和大纲
2. **AI辅助编辑**: 输入修改指令，AI 生成修改建议

### 一致性检查
编辑剧集后，AI 自动分析：
- 与前后剧集的剧情矛盾
- 与角色设定或经历的矛盾
- 时间线问题

### 自动修复
- 对于简单的事实性错误，支持一键自动修复
- 复杂问题标记为需人工审核，提供修改建议

### 编辑历史
- 完整的撤销/重做功能
- 可查看历史操作记录
- 显示操作类型（手动/AI编辑）

## API 配置

```python
from src.story_generator import GeminiClient, GeminiConfig

config = GeminiConfig(
    api_key="your-api-key",
    model_name="gemini-3-flash-preview",  # 默认模型
    temperature=0.8,
    max_output_tokens=8192
)
client = GeminiClient(config)
```

## 工作流程

1. **创建项目** - 设置故事类型、风格、集数、人物数量等
2. **生成故事大纲** - 输入创意或随机生成，AI 生成完整大纲
3. **编辑角色设定** - 完善角色信息，建立人物知识库
4. **编辑剧集大纲** - 直接编辑或 AI 辅助编辑，自动检查一致性
5. **生成分镜脚本** - 选择分镜密度，为每集生成详细分镜
6. **编辑分镜** - 调整镜头细节，AI 优化画面描述
7. **生成视频提示词** - 选择平台和类型，生成定制提示词
8. **导出使用** - 一键导出大纲，复制提示词到视频生成平台

## 人物知识库

角色的 `major_events` (重大经历) 功能用于追踪角色在每集中的重要事件:

```python
character.add_major_event(
    episode_number=1,
    description="遭遇车祸",
    impact="行动不便，需要康复"
)

# 获取角色知识库上下文 (用于 AI 生成时保持一致性)
context = character.get_knowledge_context(up_to_episode=3)
```

这确保了 AI 在生成后续剧本时能够考虑到角色之前发生的事件。

## 导出功能

点击项目详情页的"📥 导出"按钮，可下载包含以下内容的 Markdown 文件：
- 项目基本信息（类型、风格、集数等）
- 故事简介
- 完整人物设定（包括重大经历）
- 所有剧集大纲

## 依赖包

```
google-genai>=1.0.0
streamlit>=1.28.0
```

## 更新日志

- **2026-01-24**:
  - 新增人物数量自定义功能
  - 新增图生视频提示词类型（i2v、i2v_fl）
  - 优化提示词选择逻辑（尾帧需配合首帧）
  - 新增一键导出功能
- **2026-01-23**:
  - 新增剧集大纲编辑功能（直接编辑/AI辅助）
  - 新增一致性检查与自动修复
  - 新增编辑历史与撤销/重做功能
  - 新增分镜密度控制
- **2026-01**: 迁移至新版 `google-genai` SDK，模型更新为 `gemini-3-flash-preview`
